{% extends "base.html" %}
{% block title %}{{ event.name }} - Countdown{% endblock %}

{% block content %}

<div class="row justify-content-center">
  <div class="col-md-9 col-lg-7">

    <div class="card card-count p-4 text-center">
      <h2 class="mb-1">{{ event.name }}</h2>
      <div class="muted-sm mb-3">Created: {{ event.created_at|date:"Y-m-d H:i:s" }}</div>

      <div id="countFrame" class="p-3" style="border-radius:12px; background: linear-gradient(180deg, rgba(13,110,253,0.06), rgba(13,110,253,0.02));">
        <!-- data attributes for JS to read safely -->
        <div id="eventData"
             data-uid="{{ event.uid }}"
             data-event-date="{{ event.event_date|date:'c' }}"
             data-status="{{ event.status }}"
             data-remaining="{% if event.remaining_seconds %}{{ event.remaining_seconds }}{% else %}{% endif %}">
        </div>

        <div id="timer" class="count-number">-- : -- : -- : --</div>
        <div id="subLabel" class="small-muted mt-1">Remaining</div>

        <div class="d-flex justify-content-center gap-2 mt-3">
          <button id="pauseBtn" class="btn btn-outline-secondary btn-sm">Pause</button>
          <button id="resumeBtn" class="btn btn-outline-secondary btn-sm">Resume</button>
          <button id="deleteBtn" class="btn btn-danger btn-sm">Delete</button>
        </div>
      </div>

      <div class="mt-3 small-muted">
        Event ends at: <strong id="eventEnds">{{ event.event_date|date:"Y-m-d H:i:s" }}</strong>
      </div>
    </div>

  </div>
</div>

<audio id="notifSound" preload="auto">
  <source src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" type="audio/mpeg">
</audio>

<script>
(function () {
  // helpers
  function safeGet(id) { return document.getElementById(id) || null; }
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const dataEl = safeGet('eventData');
  if (!dataEl) return;

  const uid = dataEl.dataset.uid;
  const eventDateIso = dataEl.dataset.eventDate; // ISO string
  let status = dataEl.dataset.status || 'running';
  const remainingAttr = dataEl.dataset.remaining; // may be empty string
  const eventEndsEl = safeGet("eventEnds");
  const notifSound = safeGet("notifSound");
  const timerEl = safeGet("timer");
  const subLabel = safeGet("subLabel");
  const pauseBtn = safeGet("pauseBtn");
  const resumeBtn = safeGet("resumeBtn");
  const deleteBtn = safeGet("deleteBtn");
  const csrftoken = getCookie('csrftoken');

  let intervalId = null;
  let target = new Date(eventDateIso).getTime();
  let remainingSeconds = null;
  if (remainingAttr && remainingAttr !== "") {
    remainingSeconds = parseInt(remainingAttr, 10);
    if (!isNaN(remainingSeconds)) {
      // when paused we show a local ticking version (but authoritative state is on server)
      target = Date.now() + (remainingSeconds * 1000);
    } else {
      remainingSeconds = null;
    }
  }

  function msToDHMS(ms) {
    let s = Math.floor(ms / 1000);
    const d = Math.floor(s / 86400); s %= 86400;
    const h = Math.floor(s / 3600); s %= 3600;
    const m = Math.floor(s / 60); s %= 60;
    const sec = s;
    return { d, h, m, s: sec };
  }

  function formatDHMS(o) {
    return `${o.d}d : ${o.h}h : ${o.m}m : ${o.s}s`;
  }

  function computeRemainingMs() {
    return Math.max(0, target - Date.now());
  }

  function renderFinished() {
    if (intervalId) { clearInterval(intervalId); intervalId = null; }
    timerEl.innerText = "Time's up!";
    subLabel.innerText = "Finished";
    try { if (notifSound && notifSound.play) notifSound.play(); } catch (e) {}
  }

  function updateTimer() {
    const rem = computeRemainingMs();
    if (rem <= 0) {
      renderFinished();
      return;
    }
    const obj = msToDHMS(rem);
    timerEl.innerText = formatDHMS(obj);
    subLabel.innerText = (status === 'paused') ? 'Paused' : 'Remaining';
  }

  function startInterval() {
    if (intervalId) clearInterval(intervalId);
    intervalId = setInterval(updateTimer, 1000);
    updateTimer();
  }

  async function postAction(url) {
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Accept': 'application/json',
      },
    });
    return resp.json();
  }

  // actions
  if (pauseBtn) {
    pauseBtn.addEventListener('click', async function () {
      const res = await postAction(`/event/${uid}/pause/`);
      if (res.status === 'ok') {
        status = 'paused';
        if (typeof res.remaining_seconds === 'number') {
          target = Date.now() + (res.remaining_seconds * 1000);
        }
        startInterval();
        showToast("Paused", "Countdown paused and saved on server.");
      } else if (res.status === 'finished') {
        renderFinished();
        showToast("Finished", "Event already finished.");
      } else {
        showToast("Error", res.message || "Could not pause.");
      }
    });
  }

  if (resumeBtn) {
    resumeBtn.addEventListener('click', async function () {
      const res = await postAction(`/event/${uid}/resume/`);
      if (res.status === 'ok' && res.event_date_iso) {
        status = 'running';
        target = new Date(res.event_date_iso).getTime();
        if (eventEndsEl) eventEndsEl.innerText = new Date(target).toLocaleString();
        startInterval();
        showToast("Resumed", "Countdown resumed on server.");
      } else {
        showToast("Error", res.message || "Could not resume.");
      }
    });
  }

  if (deleteBtn) {
    deleteBtn.addEventListener('click', async function () {
      if (!confirm("Are you sure you want to delete this event? This action cannot be undone.")) return;
      const res = await postAction(`/event/${uid}/delete/`);
      if (res.status === 'ok') {
        showToast("Deleted", "Event deleted.");
        window.location.href = "{% url 'events_list' %}";
      } else {
        showToast("Error", res.message || "Could not delete.");
      }
    });
  }

  // Start UI
  startInterval();

})();
</script>
{% endblock %}
