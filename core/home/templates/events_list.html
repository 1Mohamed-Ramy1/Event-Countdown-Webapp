{% extends "base.html" %}
{% block title %}All Events{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1>All Countdowns</h1>
  <!-- removed duplicate Create New button (only one in navbar now) -->
</div>

<div class="row g-3">
  {% for ev in events %}
    <div class="col-md-6 col-lg-4">
      <div class="card card-count p-3 h-100" data-uid="{{ ev.uid }}"
           data-status="{{ ev.status }}"
           data-event-date="{{ ev.event_date|date:'c' }}"
           data-remaining="{% if ev.remaining_seconds %}{{ ev.remaining_seconds }}{% else %}{% endif %}">
        <h5>{{ ev.name }}</h5>
        <div class="small-muted">Created: {{ ev.created_at|date:"Y-m-d H:i:s" }}</div>

        <div class="mt-3">
          <div class="count-number" data-timer-display>-- : -- : -- : --</div>
          <div class="small-muted" data-sub-label>Remaining</div>
        </div>

        <div class="mt-3 d-flex gap-2">
          <a class="btn btn-sm btn-outline-secondary" href="{% url 'event_detail' uid=ev.uid %}">Open</a>
          <button class="btn btn-sm btn-outline-secondary btn-pause">Pause</button>
          <button class="btn btn-sm btn-outline-secondary btn-resume">Resume</button>
          <button class="btn btn-sm btn-danger btn-delete">Delete</button>
        </div>
      </div>
    </div>
  {% empty %}
    <div class="col-12">
      <div class="card card-count p-4 text-center">
        <p class="text-muted mb-0">
          No events have been created yet.
        </p>
      </div>
    </div>
  {% endfor %}
</div>

<script>
(function () {
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  function post(url) {
    return fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken, 'Accept': 'application/json' }
    }).then(r => r.json());
  }

  function msToDHMS(ms) {
    let s = Math.floor(ms / 1000);
    const d = Math.floor(s / 86400); s %= 86400;
    const h = Math.floor(s / 3600); s %= 3600;
    const m = Math.floor(s / 60); s %= 60;
    const sec = s;
    return { d, h, m, s: sec };
  }
  function fmt(o) { return `${o.d}d : ${o.h}h : ${o.m}m : ${o.s}s`; }

  document.querySelectorAll('.card.card-count').forEach(card => {
    const uid = card.dataset.uid;
    let status = card.dataset.status || 'running';
    const eventDateIso = card.dataset.eventDate;
    const remainingAttr = card.dataset.remaining;
    const displayEl = card.querySelector('[data-timer-display]');
    const subEl = card.querySelector('[data-sub-label]');
    const pauseBtn = card.querySelector('.btn-pause');
    const resumeBtn = card.querySelector('.btn-resume');
    const deleteBtn = card.querySelector('.btn-delete');

    let target = new Date(eventDateIso).getTime();
    if (status === 'paused' && remainingAttr) {
      const rem = parseInt(remainingAttr, 10);
      if (!isNaN(rem)) target = Date.now() + rem * 1000;
      subEl.innerText = "Paused";
    }

    function update() {
      const remMs = Math.max(0, target - Date.now());
      if (remMs <= 0) {
        displayEl.innerText = "Time's up!";
        subEl.innerText = "Finished";
        return;
      }
      displayEl.innerText = fmt(msToDHMS(remMs));
    }

    update();
    const intId = setInterval(update, 1000);

    if (pauseBtn) pauseBtn.addEventListener('click', async () => {
      const url = `/event/${uid}/pause/`;
      const data = await post(url);
      if (data.status === 'ok') {
        status = 'paused';
        target = Date.now() + (data.remaining_seconds * 1000);
        subEl.innerText = "Paused";
        showToast("Paused", "Countdown paused and saved on server.");
      } else {
        showToast("Error", data.message || "Could not pause.");
      }
    });

    if (resumeBtn) resumeBtn.addEventListener('click', async () => {
      const url = `/event/${uid}/resume/`;
      const data = await post(url);
      if (data.status === 'ok') {
        status = 'running';
        target = new Date(data.event_date_iso).getTime();
        subEl.innerText = "Running";
        showToast("Resumed", "Countdown resumed on server.");
      } else {
        showToast("Error", data.message || "Could not resume.");
      }
    });

    if (deleteBtn) deleteBtn.addEventListener('click', async () => {
      if (!confirm("Are you sure you want to delete this event?")) return;
      const url = `/event/${uid}/delete/`;
      const data = await post(url);
      if (data.status === 'ok') {
        showToast("Deleted", "Event deleted.");
        card.remove();
        clearInterval(intId);
      } else {
        showToast("Error", data.message || "Could not delete.");
      }
    });

  });
})();
</script>
{% endblock %}
